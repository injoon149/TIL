<h3>프로덕션 준비 기능</h3>

1. 프로덕션 준비 기능
    - 프로덕션(서비스)을 운영에 배포할 때 준비해야 하는 비기능적 요소
    - 지표, 추적, 감사, 모니터링
    - 애플리케이션이 현재 살아 있는지, 커넥션 풀은 얼마나 사용되고 있는지 등 확인하는 것
    - ex) 마이크로미터, 프로메테우스, 그라파나

2. 액츄에이터
    ``https://localhost:8080/actuator/health``
    - status : up 상태 => 현재 서버가 잘 동작하고 있는지 애플리케이션의 헬스 상태를 나타낸다.

3. 엔드포인트 설정
    - 1. 엔드포인트 활성화 : 해당 기능 자체를 사용할지 말지 on, off 선택
    - 2. 엔트포인트 누출 : 활성화된 엔드포인트를 http에 노출할지, jmx에 노출할지 선택

4. shutdown 엔드포인트 활성화
    - application.yml 통해 활성화
    - ``http://localhost:8080/actuator/shutdown`` 을 호출하면 서버가 종료된다.

5. 다양한 엔드포인트
    - 각 엔드포인트를 통해서, 개발자는 애플리케이션 내부의 수많은 기능을 관리, 모니터링할 수 있다.
    - beans : 스프링 컨테이너에 등록된 스프링 빈 보여줌
    - conditions : condition을 통해서 빈을 등록할 때 평가 조건과 일치하지 않는 이유 표시
    - env : Environment 정보
    - configprops : @ConfigurationProperties를 보여준다
    - loggers : 애플리케이션 로거 설정 표시/변경
   등 다양한 기능들이 있다.

6. 헬스 정보
    - 애플리케이션에 문제가 발생했을 때 문제를 빠르게 인지할 수 있다.
    - 애플리케이션이 사용하는 데이터베이스가 응답하는지, 디스크 사용량에는 문제가 없는지 같은 다양한 정보를 포함하여, 헬스 정보가
        만들어진다.
    - 헬스 컴포넌트(db, diskspace, ping) 중에 하나라도 문제가 있으면 현재 상태는 down이 된다.

7. 애플리케이션 정보
    - info 엔드포인트는 애플리케이션의 기본 정보를 노출한다.
    - 기본으로 제공하는 기능 
        - java : 자바 런타임 정보, os : os 정보, env : environment에서 info. 로 시작하는 정보, build : 빌드 정보, git : git정보

8. 빌드 정보
    - build : 애플리케이션의 기본 정보와 버전, 그리고 빌드된 시간을 확인할 수 있다.

9. git 정보
    - 프로젝트가 git으로 관리되고 있어야 한다.
    - 브랜치명, 커밋 id, 마지막 커밋 시점 등 git에 대한 정보를 볼 수 있다.

10. 로거
    - loggers 엔드포인트를 사용하면 로깅과 관련된 정보를 확인하고, 실시간으로 변경할 수 있다.

11. HTTP 요청 응답 기록
    - httpexchanges 엔드포인트 : http 요청과 응답의 과거 기록 확인
    - httpExchangeRepository 인터페이스의 구현체를 빈으로 등록하면, httpExchanges 엔드포인트를 사용할 수 있다.
    - 기능이 매우 단순하고, 제한이 많아 개발 단계에서만 사용하고, 실제 운영 서비스에서는 모니터링 툴, 핀포인트, zipkin 등의 기술을 사용한다.

12. 액츄에이터와 보안
    - 액츄에이터가 제공하는 기능들은 애플리케이션의 내부 기능 노출을 높인다.
    - 액츄에이터의 엔드포인트들은 외부 인터넷에서 접근이 불가능하게 막고, 내부에서만 접근 가능한 내부망을 사용하는 것이 좋다.
    - 1. 액츄에이터를 다른 포트에서 실행, ``management.server.port = 9292``
    - 2. 액츄에이터 URL 경로에 인증 설정
        - 포트 분리하는 것이 어렵고, 어쩔 수 없이 외부 인터넷 망을 통해 접근해야 한다면, /actuator 경로에 서블릿 필터, 스프링 시큐리티
        를 통해 인증된 사용자만 접근하도록 추가 개발한다.

<h3>마이크로미터</h3>

1. 마이크로미터 소개
    - 처음에 cpu, jvm, 커넥션 정보를 jmx 툴에 저장한다.
    - 중간에 사용하는 모니터링 툴을 변경하면? => 기존에 측정했던 코드를 모두 변경한 툴에 맞게 다시 변경해야 한다.
   => 이러한 문제 해결: 마이크로미터 라이브러리

2. 마이크로미터 전체 그림
    - 1. 마이크로미터 표준 방식에 맞추어 추정
    - 2. 각 툴에 맞도록(jmx 구현체, 프로메테우스 구현체) 변환해서 전달
    - 마이크로미터는 애플리케이션 메트릭 파사드라고 불리는데, 애플리케이션의 메트릭을 마이크로미터의 표준 방법으로 모아서 제공해 준다.
    - 스프링 부트 액츄에이터는 마이크로미터를 기본으로 내장해서 제공한다.
    - 개발자는 마이크로미터가 정한 표준 방법으로 메트릭을 전달하고, 사용하는 모니터링 툴에 맞는 구현체를 선택한다.
   => 모니터링 툴이 변경되어도 구현체만 변경하면 된다.

3. 메트릭 확인하기
    - CPU, JVM, 커넥션 사용 등 수많은 지표들을 수집하는 방법
    - 스프링 부트 액츄에이터를 사용하여 수많은 지표들 수집 => metrics 엔드포인트 이용

4. metrics 엔드포인트
    - 기본으로 제공되는 메트릭을 확인할 수 있다.
    - ``http://localhost:8080/actuator/metrics``

5. tag 필터
    - availabletag 통해 항목 확인
    - tag:key:value 같은 형식을 사용해서, 해당 tag를 기반으로 정보를 필터링해서 확인할 수 있다.
   ex) tag를 사용해서 힙 메모리, 힙이 아닌 메모리로 분류해서 데이터를 확인할 수 있다.

6. jvm 메트릭
    - jvm.으로 시작하여, 메모리 및 버퍼 풀 세부 정보, 스레드 활용 등의 정보를 보여준다.
   system 메트릭
    - cpu 지표, 파일 디스크립터 메트릭, 가동 시간 메트릭, 사용 가능한 디스크 공간 등을 보여준다.

7. 애플리케이션 시작 메트릭
    - application.started.time : 애플리케이션을 시작하는 데 걸리는 시간
    - application.ready.time : 애플리케이션이 요청을 처리하는 준비가 되는 데 걸리는 시간
    - 스프링은 내부에 여러 초기화 단계가 있고, 각 단계별로 내부에서 애플리케이션 이벤트를 발생시킨다.
    - ApplicationStartedEvent : 스프링 컨테이너가 완전히 실행된 상태. 이후에 커맨드 라인 러너가 호출된다.
    - ApplicationReadyEvent : 커맨드 라인 러너가 실행된 이후에 호출된다.

8. 스프링 mvc 메트릭
    - 스프링 mvc 컨트롤러가 처리하는 모든 요청을 다룬다.
    - 메트릭 이름 : http.server.requests
    - tag를 이용해서, uri, method, status, exception, outcome 등의 정보를 분류해서 확인할 수 있다.

9. 데이터소스 메트릭
    - datasource, 커넥션 풀에 관한 메트릭을 확인할 수 잇다.
    - jdbc.connections. 으로 시작한다.
    - 최대 커넥션, 최소 커넥션, 활성 커넥션, 대기 커넥션 수 등을 확인할 수 있다.

10. 로그 메트릭
    - logback.events: logback 로그에 대한 메트릭을 확인할 수 있다.
    - trace, debug, info, warn, error 각각의 로그 레벨에 따른 로그 수를 확인할 수 있다.
    ex) error 로그 수가 급격히 늘어남: 위험 신호

11. 톰캣 메트릭
    - application.yml 에 옵션 설정이 필요하다.
    - tomcat. 으로 시작한다.
    - 톰캣의 최대 쓰레드, 사용 쓰레드 수를 포함한 다양한 메트릭을 확인할 수 있다.

12. 기타 메트릭
    - HTTP 클라이언트 메트릭, 캐시 메트릭, 작업 실행과 스케줄 메트릭, 스프링 데이터 리포지토리 메트릭, MongoDB 메트릭,
        Redis 메트릭
    - 사용자 정의 메트릭도 가능

13. 정리
    - 액츄에이터: 수많은 메트릭 생성
    - 메트릭을 지속적으로 수집하고 보관할 데이터베이스, 메트릭을 그래프를 통해 한눈에 확인하는 대시보드가 필요하다. 
    => 프로메테우스와 그라파나
















