<h3>프로메테우스와 그라파나</h3>

1. 프로메테우스
    - 애플리케이션에서 발생한 메트릭을, 그 순간뿐만 아니라 과거 이력까지 확인하려면 메트릭을 보관하는 DB가 필요하다.
    - 메트릭을 지속해서 수집하고 DB에 저장하는 담당
   그라파나
    - 프로메테우스가 DB라고 하면, 이 DB에 있는 데이터를 불러서 사용자가 보기 편하게 보여 주는 대시보드가 필요하다.
    - 그라파나는 매우 유연하고, 데이터를 그래프로 보여 주는 틀이다.
    - 수많은 그래프를 제공하고, 프로메테우스를 포함한 다양한 데이터소스를 지원한다.

2. 전체 구조
    - 1. 스프링 부트 액츄에이터와 마이크로미터를 사용하면 수많은 메트릭을 자동으로 생성한다.
         - 마이크로미터 프로메테우스 구현체는 프로메테우스가 읽을 수 있는 포맷으로 메트릭 생성
      2. 프로메테우스는 이 메트릭 지속적으로 수집
      3. 프로메테우스는 수집한 메트릭을 내부 DB에 저장
      4. 사용자는 그라파나 대시보드 툴을 이용해 그래프로 메트릭 조회

3. 프로메테우스 - 작업 과정
   - 1. 애플리케이션 설정 : 프로메테우스가 애플리케이션의 메트릭을 가져갈 수 있도록 애플리케이션에서 프로메테우스 포맷에 
         맞추어 메트릭 만들기
     2. 프로메테우스 설정 : 프로메테우스가 우리 애플리케이션의 메트릭을 주기적으로 수집하도록 설정

4. 프로메테우스 - 기본 기능
   - 태그, 레이블 : 각각의 메트릭 정보를 구분해서 사용하기 위한 태그
   - Table : Evaluation time을 수정해서 과거 시간 조회 가능
   - Graph : 메트릭을 그래프로 조회 가능
   - 레이블(태그)을 기준으로 필터를 사용할 수 있다.

5. 프로메테우스 - 게이지와 카운터
   - 1. 게이지 : 임의로 오르내릴 수 있는 값
      ex) CPU 사용량, 메모리 사용량, 커넥션 사용량
     2. 카운터 : 단순하게 증가하는 단일 누적 값
      ex) HTTP 요청 수, 로그 발생 수
   - 게이지는 오르락내리락 하는 값이고, 카운터는 특정 이벤트가 발생할 때마다 그 수를 계속 누적하는 값이다.
   - 게이지는 CPU 사용량같이 있는 그대로를 사용하면 되어서 사용하기 쉽다.
   - 카운터는 그래프로 그리면 계속 증가하기만 해서, 특정 시간대 고객 요청 등을 확인하려면 increase(), rate() 등의 함수가 필요하다.

6. 카운터 함수
   - increase()[시간] : 지정한 시간 단위별로 증가를 확인할 수 있다.
      ex) increase(http_server_requests_second_count{uri="/log"}[1m]) : 분당 얼마나 고객의 요청이 증가했는지 확인
   - rate() : 범위 벡터에서 초당 평균 증가율을 계산한다.
      ex) increase()는 숫자 직접 카운트, rate()는 초당 평균 나누어 계산
   - irate() : rate와 유사한데, 범위 벡터에서 초당 순간 증가율을 계산한다.

7. 그라파나 - 대시보드 생성
   - 애플리케이션 생성, 프로메테우스 실행, 그라파나 실행 모두 필요하다.
   - 대시보드는 큰 틀, 패널은 그 안에 모듈처럼 들어가는 실제 그래프를 보여주는 컴포넌트이다.

<h3>스프링 부트 - 비즈니스 메트릭</h3>

8. 비즈니스의 실시간 주문 수, 취소 수, 실시간 재고 수량 확인
   - 주문 수, 취소 수
      - 상품 주문 : 주문 수 증가
      - 상품 취소 : 주문 수 유지, 취소 수 증가 : 계속 증가하므로 카운터 사용
   - 재고 수량
      - 상품 주문 : 재고 수량 감소
      - 상품 취소 : 재고 수량 증가
      - 재고 물량 들어옴 : 재고 수량 증가 : 증가 또는 감소하므로 게이지 사용

9. 메트릭 등록 1 - 카운터
   - 주문 수, 취소 수 바탕으로 카운터 메트릭 등록
   - 1. MeterRegistry
      - 마이크로미터 기능을 제공하는 핵심 컴포넌트
      - 스프링을 통하여 주입받아서 사용하고, 이곳을 통해서 카운터, 게이지 등을 등록한다.
     2. counter(카운터)
      - 단조롭게 증가하는 단일 누적 측정 항목
      - 단일 값, 보통 하나씩 증가, 누적이므로 전체 값 포함, 프로메테우스는 일반적으로 카운터의 이름 마지막에 _total을 붙여서 
         my_order_total로 표현
      - 값 증가하거나 0으로 초기화만 가능

10. 카운터 생성 - 코드
   ``counter.builder("my.order").tag("class", this.getclass().getName()).tag("method", "order").description(
"order").register(registry).increment()``

   - counter.builder(name)을 통해서 카운터를 생성한다. name에는 메트릭 이름을 지정한다.
   - tag : 프로메테우스 내 레이블로 지정
   - register(registry) : 만든 카운터를 MeterRegistry에 실제로 등록
   - increment : 카운터 값을 하나 증가시킨다.
   - 각 메서드를 하나 호출할 때마다 카운터가 증가한다.
   
11. v1의 단점 개선
   - 단점 : 메트릭을 관리하는 로직이 핵심 비즈니스 개발 로직에 침투해 있다.
   - 해결 : AOP
   - 1. @Counted 애노테이션을, 측정을 원하는 메서드(주문, 취소 메서드)에 지정한다.
   - 2. 그리고 메트릭 이름을 지정한다. ``@Counted("my.order")``

   - config 파일에 CountedAspect을 등록하면, @Counted를 인지해서, counter를 사용하는 aop를 적용한다.
   - @Counted를 사용하면 result, exception, method, class 등의 다양한 tag를 자동으로 적용한다.
   

12. 메트릭 등록3 - Timer
   - Timer는 카운터와 유사한데, 실행 시간도 함께 측정할 수 있다.
   - Timer의 측정 내용
      - 1. seconds_count : 누적 실행 수 - 카운터
      - 2. seconds_sum : 실행 시간의 합 - sum
      - 3. seconds_max : 가장 오래 걸린 실행 시간 - 게이지
   - 내부의 타임 윈도우라는 개념 때문에, 1~3분마다 최대 실행 시간이 다시 계산된다.

13. Timer - 구현
   ``Timer timer = Timer.builder("my.order").tag("class", this.getclass().getName()).tag("method", "order")
.description("order").register(registry)``
   - 1. Timer.builder(name)을 통해 타이머를 생성한다. name에는 메트릭 이름을 지정한다.
   - 2. tag는, 프로메테우스에서 필터할 수 있는 레이블로 사용된다.
   - 3. 주문과 취소는 tag를 통해 구분한다.
   - 4. register(registry) : 만든 타이머를 MeterRegistry에 등록한다.
   - 5. 타이머를 사용할 때는 timer.record()을 사용한다.

14. Timer - 프로메테우스로 메트릭 확인
   - 1. seconds_count : 누적 실행 수
   - 2. seconds_sum : 실행 시간의 합
   - 3. seconds_max : 최대 실행 시간, 프로메테우스 게이지
   - 4. seconds_sum / seconds_max : 평균 실행시간

15. AOP
   - Aspect Oriented Programming
   - 어떤 목적을 기준으로 핵심, 부가적인 과정으로 나누어서 보고, 그 관점을 기준으로 각각 모듈화한다.
   - 흩어진 관심사를 Aspect로 모듈화하고, 핵심적인 비즈니스 로직에서 분리하여 재사용한다.

16. 메트릭 등록 - @Timed
   - 타이머는 @Timed라는 애노테이션을 통해 AOP를 적용할 수 있다.
   - @Timed("my.order") : 타입에 적용하면, 해당 타입의 모든 public 메서드에 타이머가 적용된다.

17. 메트릭 등록5 - 게이지
   - 1. 게이지
      - 임의로 오르내릴 수 있는 단일 숫자 값을 나타내는 메트릭
      - 값의 현재 상태를 보는 데 사용
         ex) 차량의 속도, Cpu 사용량, 메모리 사용량
      - 카운터는 값이 감소x, 게이지는 값이 감소할 수 있음.
      - my.stock이라는 이름으로 게이지 등록 : 게이지를 만들 때 함수를 전달하고, 이 함수는 외부에서 메트릭을 확인할 때마다 호출된다.





















